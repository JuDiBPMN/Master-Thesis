import json
import pm4py
from pm4py.objects.petri_net.obj import PetriNet, Marking
from pm4py.objects.petri_net.utils import petri_utils
from pm4py.visualization.petri_net import visualizer as pn_visualizer
from pm4py.algo.analysis.workflow_net import algorithm as wf_net_logic

def generate_thesis_wf_net(json_path):
    with open(json_path, 'r') as f:
        data = json.load(f)

    net = PetriNet("Master_Thesis_Petri_Net")
    transitions = {}

    # 1. Transitions (T)
    # Labeled for tasks, Silent (None) for gateways
    for node_list, is_task in [(data.get('tasks', []), True), (data.get('gateways', []), False)]:
        for node in node_list:
            label = node.get('name') if is_task else None
            t = PetriNet.Transition(node['id'], label)
            net.transitions.add(t)
            transitions[node['id']] = t

    # 2. Places (P) and Arcs (F)
    for i, flow in enumerate(data.get('sequence_flows', [])):
        p = PetriNet.Place(f"p_{i}")
        net.places.add(p)
        src, tgt = flow['from'], flow['to']
        if src in transitions and tgt in transitions:
            petri_utils.add_arc_from_to(transitions[src], p, net)
            petri_utils.add_arc_from_to(p, transitions[tgt], net)

    # 3. Marking (Initial and Final)
    im, fm = Marking(), Marking()
    all_targets = {f['to'] for f in data['sequence_flows']}
    all_sources = {f['from'] for f in data['sequence_flows']}

    for node_id, trans in transitions.items():
        if node_id not in all_targets:
            start_p = PetriNet.Place("source")
            net.places.add(start_p)
            petri_utils.add_arc_from_to(start_p, trans, net)
            im[start_p] = 1
        if node_id not in all_sources:
            sink_p = PetriNet.Place("sink")
            net.places.add(sink_p)
            petri_utils.add_arc_from_to(trans, sink_p, net)
            fm[sink_p] = 1

    # Soundness check - checked eigenlijk gewoon ofdat er één begin en één end node is
    is_wf_net = wf_net_logic.apply(net)
    print(f"Mathematical Verification: Is this a valid Workflow Net? {is_wf_net}")

    # 4. Rendering (Fixed the AttributeError logic)
    # We now use a simple dictionary for parameters
    parameters = {
        "format": "png",
        "debug": False
    }
    
    gviz = pn_visualizer.apply(net, im, fm, parameters=parameters)
    pn_visualizer.view(gviz)

# Execute
path = '/Users/julesnuytten/Desktop/Thesis/Master-Thesis/temporary_json_outputs/case_2_model_extracted_bpmn.json'
generate_thesis_wf_net(path)